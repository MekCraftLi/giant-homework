/**
 ***********************************************************************************************************************
 * @file           : app-ui.c
 * @brief          : UI界面的业务逻辑处理
 * @author         : 李嘉豪
 * @date           : 2025-07-05
 ***********************************************************************************************************************
 * @attention
 *
 * UI界面的业务逻辑处理文件
 *
 ***********************************************************************************************************************
 **/




/* ------- includes --------------------------------------------------------------------------------------------------*/

#include "../Services/graph-service.h"
#include "app-ui.h"
#include <string.h>




/* ------- typedef ---------------------------------------------------------------------------------------------------*/





/* ------- define ----------------------------------------------------------------------------------------------------*/

#define UI_SELECT_INDEX_QUANTITY 6




/* ------- macro -----------------------------------------------------------------------------------------------------*/

#define UI_SELECTED_GOTO_NEXT(x)                                                                                       \
    do {                                                                                                               \
        x++;                                                                                                           \
        if (x >= UI_SELECT_INDEX_QUANTITY) {                                                                           \
            x = 0;                                                                                                     \
        }                                                                                                              \
    } while (0);

#define UI_SELECTED_GOTO_PREV(x)                                                                                       \
    do {                                                                                                               \
        if (x == 0) {                                                                                                  \
            x = UI_SELECT_INDEX_QUANTITY - 1;                                                                          \
        } else {                                                                                                       \
            x--;                                                                                                       \
        }                                                                                                              \
    } while (0);




/* ------- function prototypes ---------------------------------------------------------------------------------------*/

static void actionWhileBrowse(void* argument);
static void actionWhileEdit(void* argument);
static void actionWhileFigureView(void* argument);

static void browseAnimate(void* argument);



/* ------- variables -------------------------------------------------------------------------------------------------*/


// UI状态机列表
static UIStateTransitionTypeDef uiStateMachineList[] = {
    {UI_STATE_ADJUST_BROUWSE, UI_STATE_ADJUST_EDIT, UI_EVENT_VALUE_SELECT, actionWhileBrowse},
    {UI_STATE_ADJUST_EDIT, UI_STATE_ADJUST_BROUWSE, UI_EVENT_VALUE_UNSELECT, actionWhileEdit},
    {UI_STATE_ADJUST_BROUWSE, UI_STATE_FIGURE_VIEW, UI_EVENT_FIGURE_VIEW, actionWhileBrowse},
    {UI_STATE_FIGURE_VIEW, UI_STATE_ADJUST_BROUWSE, UI_EVENT_FIGURE_EXIT, actionWhileFigureView},
};

// UI选择信息显示数据
static UISelDispInfoTypeDef uiSelInfoDispList[] = {
    // 信号1频率选择数据
    {{SIGNAL_1_FREQ}, {32, 17, 76, 29, 3}},
    // 信号2频率选择数据
    {{SIGNAL_2_FREQ}, {76, 16, 128, 32, 3}},
    // 信号1幅度选择数据
    {{SIGNAL_1_AMP}, {30, 32, 76, 48, 3}},
    // 信号2幅度选择数据
    {{SIGNAL_2_AMP}, {76, 32, 128, 48, 3}},
    // 信号1相位选择数据
    {{SIGNAL_1_PHASE}, {30, 48, 76, 64, 3}},
    // 信号2相位选择数据
    {{SIGNAL_2_PHASE}, {76, 48, 128, 64, 3}},
};


const uint8_t img[1024] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x40, 0xF0, 0x0C, 0x10, 0x50, 0x50, 0x54, 0x58, 0x50, 0x50, 0x10, 0x00, 0x80, 0x80, 0xBC, 0xA4, 0xA4,
    0xA4, 0xA4, 0xA4, 0xBC, 0x80, 0x80, 0x00, 0x00, 0x10, 0x10, 0xF8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0xF0, 0x0C, 0x10, 0x50, 0x50, 0x54,
    0x58, 0x50, 0x50, 0x10, 0x00, 0x80, 0x80, 0xBC, 0xA4, 0xA4, 0xA4, 0xA4, 0xA4, 0xBC, 0x80, 0x80, 0x00, 0x00, 0x30,
    0x08, 0x08, 0x08, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80,
    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xFF, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xBF, 0x80,
    0x80, 0xBD, 0x95, 0x95, 0x95, 0x95, 0xBD, 0x80, 0x80, 0x80, 0x80, 0x86, 0x85, 0x84, 0x84, 0x84, 0xA4, 0xA4, 0x9C,
    0x80, 0x80, 0x80, 0x88, 0x88, 0x8F, 0x88, 0x88, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xFF, 0x80, 0x80,
    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xBF, 0x80, 0x80, 0xBD, 0x95, 0x95, 0x95, 0x95, 0xBD, 0x80, 0x80,
    0x80, 0x80, 0x86, 0x85, 0x84, 0x84, 0x84, 0xA4, 0xA4, 0x9C, 0x80, 0x80, 0x80, 0x88, 0x8C, 0x8A, 0x89, 0x88, 0x80,
    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x40, 0x78, 0x40, 0xFC, 0x48, 0x48, 0xE4,
    0x34, 0xAC, 0x24, 0xE4, 0x00, 0x08, 0x28, 0x48, 0x68, 0x58, 0xCC, 0x48, 0x28, 0x48, 0x28, 0x08, 0x00, 0x00, 0x00,
    0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0xA4, 0xA3, 0x90, 0x8B, 0x84, 0x82, 0xA7, 0x90, 0x8F, 0x90, 0xA7, 0x80,
    0x88, 0x8A, 0x89, 0x8A, 0x8B, 0xBE, 0x8B, 0x8A, 0x89, 0x8A, 0x88, 0x80, 0x80, 0x80, 0x80, 0xFF, 0x80, 0x80, 0x80,
    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xFF, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00,
    0x00, 0x00, 0xF0, 0x10, 0xFC, 0x10, 0xF0, 0x00, 0x74, 0x54, 0x54, 0x54, 0x74, 0x00, 0x00, 0xF8, 0x28, 0x28, 0xF8,
    0xA8, 0xAC, 0xA8, 0xF8, 0x28, 0x28, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x87, 0x80, 0xBF,
    0x84, 0x87, 0x80, 0xBF, 0x95, 0x9F, 0x95, 0xBF, 0x80, 0xA0, 0x9F, 0x80, 0xA2, 0xA6, 0xAA, 0x92, 0x92, 0xAA, 0xA6,
    0xA0, 0x80, 0x80, 0x80, 0x80, 0xFF, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xFF, 0x80, 0x80, 0x80,
    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x20, 0xA0, 0xFC, 0x20, 0x00, 0xF8, 0x48, 0x48,
    0x48, 0x48, 0xF8, 0x00, 0x40, 0xF0, 0x0C, 0x20, 0xA0, 0x20, 0x24, 0x28, 0x20, 0xA0, 0x20, 0x00, 0x00, 0x00, 0x00,
    0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x01, 0x3F, 0x01, 0x00, 0x3F, 0x12, 0x12, 0x12, 0x12, 0x3F, 0x00, 0x00,
    0x3F, 0x00, 0x20, 0x21, 0x2E, 0x20, 0x30, 0x2C, 0x23, 0x20, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

const uint8_t font0[2][5]               = {{0xFE, 0x01, 0x11, 0x01, 0xFE}, {0x00, 0x01, 0x01, 0x01, 0x00}}; // 字体0
const uint8_t font1[2][5]               = {{0x81, 0x81, 0xFF, 0x01, 0x01}, {0x00, 0x00, 0x01, 0x00, 0x00}}; // 字体1




// 点阵图像素数据
static uint8_t dotMatrix[HEIGHT][WIDTH] = {0};

static uint8_t strBuffer[6][8];


/* ------- function implement ----------------------------------------------------------------------------------------*/

/**
 * @brief UI应用初始化函数
 *
 * @param argument
 */
void uiAppInit(void* argument) {
    UIAppParamTypeDef* pParam = (UIAppParamTypeDef*)argument;


    memcpy(pParam->graphicsBuffers[0], img, sizeof(img)); // 初始化图形缓冲区


    pParam->browseAnimateTimer      = timeServIntf.softTimerRegister();
    pParam->event                   = UI_EVENT_NONE;                           // 初始化事件为无
    pParam->curState                = UI_STATE_ADJUST_BROUWSE;                 // 初始状态为浏览状态
    pParam->selectIndex             = SIGNAL_1_FREQ;                           // 初始选择索引为信号1频率
    pParam->animateData.pCurSelInfo = &uiSelInfoDispList[pParam->selectIndex]; // 设置当前选择信息
    pParam->dotMatrix               = dotMatrix;                               // 设置点阵图像素
    graphServIntf.drawRoundRect2DotMatrix(pParam->dotMatrix, 30, 16, 79, 32, 5);
}

/**
 * @brief UI应用循环函数
 *
 * @param argument
 */
void uiAppLoop(void* argument) {
    // 遍历状态机列表，检查每个状态机的条件函数
    UIAppParamTypeDef* pParam = (UIAppParamTypeDef*)argument;

    // 处理前切换了缓冲区
    pParam->bufferIndex       = !pParam->bufferIndex; // 切换图形缓冲区索引

    for (int i = 0; i < sizeof(uiStateMachineList) / sizeof(UIStateTransitionTypeDef); i++) {
        if (uiStateMachineList[i].curState == pParam->curState) {
            if (pParam->event == uiStateMachineList[i].event) {
                pParam->curState = uiStateMachineList[i].nextState;
                break;
            }
            // 执行状态动作函数
            uiStateMachineList[i].actionFunc(argument);
        }
    }
}

/**
 * @brief 浏览状态下的动作函数
 *
 * @param argument
 */
static void actionWhileBrowse(void* argument) {
    UIAppParamTypeDef* pParam = (UIAppParamTypeDef*)argument;
    memset(pParam->dotMatrix, 0, HEIGHT * WIDTH);


    memcpy(pParam->graphicsBuffers[pParam->bufferIndex], img, sizeof(img)); // 恢复图形缓冲区

    sprintf("%.2f", pParam->signalInfo[0].freq, strBuffer[0]);




    browseAnimate(argument); // 浏览动画处理

    // 绘制当前选择信息的圆角矩形
    graphServIntf.drawRoundRect2DotMatrix(pParam->dotMatrix, pParam->selDispInfo.rectParam.startX,
                                          pParam->selDispInfo.rectParam.startY, pParam->selDispInfo.rectParam.endX,
                                          pParam->selDispInfo.rectParam.endY, pParam->selDispInfo.rectParam.radius);

    // 将圆角矩形区域颜色反转
    graphServIntf.InverBufferWithMask(pParam->dotMatrix, pParam->graphicsBuffers[pParam->bufferIndex]);
}

/**
 * @brief 编辑状态下的动作函数
 *
 * @param argument
 */
static void actionWhileEdit(void* argument) {}


/**
 * @brief 图形查看状态下的动作函数
 *
 * @param argument
 */
static void actionWhileFigureView(void* argument) {}


/**
 * @brief 浏览动画处理函数
 *
 * @param argument
 */
static void browseAnimate(void* argument) {

    UIAppParamTypeDef* pParam = (UIAppParamTypeDef*)argument;

    // 如果触发了切换选择事件
    if (pParam->event == UI_EVENT_SELECT_NEXT || pParam->event == UI_EVENT_SELECT_PREV) {
        // 进入过渡状态
        // 开始软定时器计时
        pParam->animateData.transitionState = 1;
        pParam->animateData.elapsed         = timeServIntf.getElapsedTime(pParam->browseAnimateTimer);

        // 设置下一个选择信息
        if (pParam->event == UI_EVENT_SELECT_NEXT) {
            // 如果是下一个选择事件，更新选择索引并获取下一个选择信息
            uint8_t nextIndex = pParam->selectIndex;
            UI_SELECTED_GOTO_NEXT(nextIndex);
            pParam->animateData.pNextSelInfo = &uiSelInfoDispList[nextIndex];
        } else if (pParam->event == UI_EVENT_SELECT_PREV) {
            uint8_t prevIndex = pParam->selectIndex;
            UI_SELECTED_GOTO_PREV(prevIndex);
            pParam->animateData.pNextSelInfo = &uiSelInfoDispList[prevIndex];
        }

    } else if (pParam->animateData.transitionState == 1) {

        // 如果处于过渡状态，更新动画数据

        pParam->animateData.elapsed = timeServIntf.getElapsedTime(pParam->browseAnimateTimer);

        if (pParam->animateData.elapsed >= pParam->animateData.duration) {
            // 如果已经经过的时间超过了持续时间，结束过渡状态
            pParam->animateData.transitionState = 0;                                // 过渡状态结束
            pParam->animateData.elapsed         = 0.0f;                             // 重置已经经过的时间
            pParam->animateData.pCurSelInfo     = pParam->animateData.pNextSelInfo; // 更新当前选择信息
        }
    } else if (pParam->animateData.transitionState == 0) {

        // 如果不处于过渡状态，直接显示当前选择信息
        pParam->selDispInfo = *pParam->animateData.pCurSelInfo;
    }
}
