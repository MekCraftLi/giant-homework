/**
 ***********************************************************************************************************************
 * @file           : systick.c
 * @brief          : 系统滴答定时器配置
 * @author         : 李嘉豪
 * @date           : 2025-04-05
 ***********************************************************************************************************************
 * @attention
 *
 * None
 *
 ***********************************************************************************************************************
 **/




/* ------- includes --------------------------------------------------------------------------------------------------*/
#include "stm32f10x.h"

#include "core_cm3.h"
#include "systick.h"





/* ------- typedef ---------------------------------------------------------------------------------------------------*/





/* ------- define ----------------------------------------------------------------------------------------------------*/





/* ------- macro -----------------------------------------------------------------------------------------------------*/





/* ------- function prototypes ---------------------------------------------------------------------------------------*/

void systInit(void);
void systCount(uint32_t count);




/* ------- variables -------------------------------------------------------------------------------------------------*/

SystIntfTypeDef systIntf = {
    .systInit           = systInit,
    .systDelayClkCycles = systCount,
};




/* ------- function implement ----------------------------------------------------------------------------------------*/

void systInit(void) {
    SysTick->CTRL = 0;

    SysTick->LOAD = 0;

    SysTick->VAL  = 0;

    SysTick->CTRL = 0x04;
}

void systCount(uint32_t count) {
    if (count == 0) {
        return;
    }

    SysTick->LOAD = count - 1;
    SysTick->VAL  = 0;
    SysTick->CTRL = 0x05;

    /* 等待延时结束 */
    while ((SysTick->CTRL & SysTick_CTRL_COUNTFLAG_Msk) == 0)
        ;
    SysTick->CTRL = 0x04;

    /* 禁用SysTick */
}
